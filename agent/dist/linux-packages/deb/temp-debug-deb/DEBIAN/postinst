#!/bin/bash

set -e

# Check if osquery is installed first
if ! command -v osqueryi &> /dev/null; then
    echo "‚ùå OSQuery not found!"
    echo "Please install osquery first:"
    echo ""
    if [ -f /etc/debian_version ]; then
        echo "  # Add osquery repository"
        echo "  curl -L https://pkg.osquery.io/deb/GPG | sudo apt-key add -"
        echo "  echo 'deb [arch=amd64] https://pkg.osquery.io/deb deb main' | sudo tee /etc/apt/sources.list.d/osquery.list"
        echo "  sudo apt update && sudo apt install osquery"
    elif [ -f /etc/redhat-release ]; then
        echo "  # Add osquery repository"
        echo "  curl -L https://pkg.osquery.io/rpm/GPG | sudo rpm --import -"
        echo "  sudo yum-config-manager --add-repo https://pkg.osquery.io/rpm/osquery-s3-rpm.repo"
        echo "  sudo yum install osquery"
    else
        echo "  Visit: https://osquery.io/downloads/linux"
    fi
    echo ""
    echo "Then reconfigure the package: sudo dpkg-reconfigure scanx"
    exit 1
fi

# Configuration setup
config_file="/etc/scanx/config/agent.conf"

echo "üìã scanx Configuration"
echo "========================="

# Get email from user
while true; do
    read -p "üìß Enter employee email (required): " user_email
    if [[ -n "$user_email" && "$user_email" == *"@"* ]]; then
        break
    else
        echo "‚ùå Please enter a valid email address"
    fi
done

# Get interval from user (default to 2 hours)
echo ""
echo "‚è±Ô∏è  Data collection interval examples:"
echo "   - 5m   (5 minutes)"
echo "   - 10m  (10 minutes)"
echo "   - 1h   (1 hour)"
echo "   - 2h   (2 hours - default)"
read -p "‚è±Ô∏è  Enter collection interval [2h]: " user_interval
if [[ -z "$user_interval" ]]; then
    user_interval="2h"
fi

# Update configuration
sed -i "s/\"user_email\": \"[^\"]*\"/\"user_email\": \"$user_email\"/" "$config_file"
sed -i "s/\"interval\": \"[^\"]*\"/\"interval\": \"$user_interval\"/" "$config_file"

echo ""
echo "‚úÖ Configuration updated:"
echo "   üìß Email: $user_email"
echo "   ‚è±Ô∏è  Interval: $user_interval"

# Create log file
touch /var/log/scanx/scanx-std.log
chmod 644 /var/log/scanx/scanx-std.log

# Enable and start service
systemctl daemon-reload
systemctl enable scanx
systemctl start scanx

echo ""
echo "üéâ scanx installed and started successfully!"
echo ""
echo "üìã File locations:"
echo "   Binary:  /usr/local/bin/scanx"
echo "   Config:  /etc/scanx/config/"
echo "   Logs:    /var/log/scanx/scanx-std.log"
echo "   Data:    /var/lib/scanx/"
echo ""
echo "üìã Service commands:"
echo "   Status:  systemctl status scanx"
echo "   Logs:    journalctl -u scanx -f"
echo "   Stop:    systemctl stop scanx"

exit 0
