<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" 
           Name="scanx" 
           Language="1033" 
           Version="1.0.0" 
           Manufacturer="Your Company" 
           UpgradeCode="12345678-1234-1234-1234-123456789012">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine"
             Description="scanx - System Monitoring and Device Management" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Features -->
    <Feature Id="ProductFeature" Title="scanx" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ServiceComponent" />
    </Feature>

    <!-- Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="scanx">
          <Directory Id="ConfigFolder" Name="config" />
          <Directory Id="LogsFolder" Name="logs" />
        </Directory>
      </Directory>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="CompanyDataFolder" Name="scanx" />
      </Directory>
    </Directory>

    <!-- Components -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="11111111-1111-1111-1111-111111111111">
        <File Id="scanx.exe" Source="dist/builds/scanx-windows-amd64.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigFiles" Guid="22222222-2222-2222-2222-222222222222" Directory="ConfigFolder">
        <File Id="agent.conf" Source="config/agent.conf" />
        <File Id="queries.yml" Source="config/queries.yml" />
      </Component>
    </ComponentGroup>

    <!-- Service Component -->
    <Component Id="ServiceComponent" Directory="INSTALLFOLDER" Guid="33333333-3333-3333-3333-333333333333">
      <ServiceInstall Id="scanxService"
                      Type="ownProcess"
                      Name="scanx"
                      DisplayName="scanx"
                      Description="scanx - System Monitoring and Device Management"
                      Start="auto"
                      Account="LocalSystem"
                      ErrorControl="ignore"
                      Interactive="no"
                      Arguments="-daemon">
        <ServiceDependency Id="Tcpip" />
      </ServiceInstall>
      
      <ServiceControl Id="StartService" 
                      Start="install" 
                      Stop="both" 
                      Remove="uninstall" 
                      Name="scanx" 
                      Wait="yes" />
    </Component>

    <!-- UI -->
    <UI>
      <UIRef Id="WixUI_Minimal" />
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchConfigDialog">WIXUI_EXITDIALOGOPTIONALTEXT</Publish>
    </UI>

    <!-- Custom Actions for Configuration -->
    <CustomAction Id="LaunchConfigDialog" 
                  BinaryKey="WixCA" 
                  DllEntry="CAQuietExec" 
                  Execute="immediate" 
                  Return="ignore" />

    <!-- Properties -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Configuration setup will launch after installation." />
    <Property Id="USER_EMAIL" />
    <Property Id="COLLECTION_INTERVAL" Value="2h" />

  </Product>
</Wix>
